<div class="users-dashboard">
    <div class="dashboard-header">
        <h1 class="dashboard-title">Panel Actividad de Usuarios</h1>

        <div class="filters-container flex gap-4 items-center">
            <div class="date-filter">
                <input type="date" id="date-filter"
                    class="px-4 py-2 border rounded-lg bg-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="search-container">
                <input type="text" id="username-search" placeholder="Buscar por usuario..." class="search-input">
                <button class="search-button">
                    <!-- icono lupa -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="users-container" id="users-container"></div>
    <div id="modals-container"></div>

    <div class="pagination-container">
        <button id="prev-page" class="pagination-button" disabled>Anterior</button>
        <div class="page-numbers" id="page-numbers"></div>
        <button id="next-page" class="pagination-button">Siguiente</button>
    </div>

    <div class="overlay" id="overlay"></div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("username-search");
        let userCards = [];
        let filteredUsers = [];
        const usersContainer = document.getElementById("users-container");
        const modalsContainer = document.getElementById("modals-container");

        const prevBtn = document.getElementById("prev-page");
        const nextBtn = document.getElementById("next-page");
        const pageNumbers = document.getElementById("page-numbers");
        const dateFilter = document.getElementById("date-filter");

        let currentPage = 1;
        const itemsPerPage = 15;

        const today = new Date().toISOString().split('T')[0];
        if (!dateFilter.value) {
            dateFilter.value = today;
        }

        dateFilter.addEventListener("change", async (e) => {
            const selectedDate = e.target.value;
            if (!selectedDate) return;

            try {
                const response = await fetch("/get-logs-by-date", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ date: selectedDate }),
                });

                if (!response.ok) throw new Error("Error fetching data");

                const usersData = await response.json();
                updateUsersData(usersData);
            } catch (error) {
                console.error("Error:", error);
                alert("Error al cargar los datos");
            }
        });

        function updateUsersData(usersData) {
            console.log(usersData);
            const cardsHTML = usersData.map((user, index) => `
    <div class="user-card" data-username="${user.username.toLowerCase()}">
      <header class="card-header">
        <div class="avatar">${user.username.charAt(0).toUpperCase()}</div>
        <div class="user-info">
          <h3 class="username">${user.username}</h3>
          <span class="ip-address">${user.ip}</span>
        </div>
      </header>

      <div class="card-action">
        <button class="activity-button" onclick="event.stopPropagation(); openLogsModal(${index});">
          ACTIVIDAD
        </button>
      </div>

      <footer class="card-footer">
        <div class="footer-item">
          <span class="label">Requests:</span>
          <span class="value">${user.total_requests}</span>
        </div>
        <div class="footer-item">
          <span class="label">Data:</span>
          <span class="value">${formatBytes(user.total_data)}</span>
        </div>
      </footer>
    </div>
  `).join('');

            const modalsHTML = usersData.map((user, index) => `
    <div class="logs-modal" id="logs-modal-${index}">
      <div class="modal-content">
        <span class="close-modal" onclick="closeLogsModal(${index})">&times;</span>
        <h4 class="logs-title">Actividad reciente - <span class="username-highlight">${user.username}</span></h4>
        <div class="logs-list">
          ${user.logs.length > 0
            ? user.logs.map(log => `
              <div class="log-entry">
                <div class="log-url">${truncate(log.url, 40)}</div>
                <div class="log-details">
                  <span class="response-badge response-${log.response}">${log.response}</span>
                  <span class="log-meta">${log.request_count} reqs</span>
                  <span class="log-meta">${formatBytes(log.data_transmitted)}</span>
                </div>
              </div>
            `).join('')
            : '<div class="no-logs">No hay actividad registrada</div>'}
        </div>
      </div>
    </div>
  `).join('');

            usersContainer.innerHTML = cardsHTML;
            modalsContainer.innerHTML = modalsHTML;

            userCards = Array.from(document.querySelectorAll(".user-card"));
            filteredUsers = [...userCards];

            renderPage(1);
            filterUsers();
        }

        function truncate(str, n) {
            return str.length > n ? str.slice(0, n - 1) + "..." : str;
        }

        function formatBytes(bytes) {
            const units = ["B", "KB", "MB", "GB"];
            let value = bytes;
            let unitIndex = 0;
            while (value >= 1024 && unitIndex < units.length - 1) {
                value /= 1024;
                unitIndex++;
            }
            return `${value.toFixed(2)} ${units[unitIndex]}`;
        }

        function renderPage(page = 1) {
            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
            currentPage = Math.min(Math.max(1, page), totalPages);

            userCards.forEach(card => (card.style.display = "none"));

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = filteredUsers.slice(start, end);

            pageItems.forEach(card => (card.style.display = ""));

            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;

            pageNumbers.innerHTML = `PÃ¡gina ${currentPage} de ${totalPages}`;
        }

        function filterUsers() {
            const searchValue = searchInput.value.toLowerCase();
            filteredUsers = userCards.filter(card => {
                const username = card.getAttribute("data-username");
                return username.includes(searchValue);
            });
            renderPage(1);
        }

        searchInput.addEventListener("input", filterUsers);
        prevBtn.addEventListener("click", () => renderPage(currentPage - 1));
        nextBtn.addEventListener("click", () => renderPage(currentPage + 1));

        renderPage(1);
        dateFilter.dispatchEvent(new Event("change"));
    });

    function openLogsModal(index) {
        document.getElementById(`logs-modal-${index}`).classList.add("active");
    }

    function closeLogsModal(index) {
        document.getElementById(`logs-modal-${index}`).classList.remove("active");
    }
</script>
