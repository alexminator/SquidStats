<div class="users-dashboard">
  <div class="dashboard-header">
    <h1 class="dashboard-title">Panel Actividad de Usuarios</h1>

    <div class="filters-container flex gap-4 items-center">
      <div class="date-filter">
        <input type="date" id="date-filter"
          class="px-4 py-2 border rounded-lg bg-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <div class="search-container">
        <input type="text" id="username-search" placeholder="Buscar por usuario..." class="search-input">
        <button class="search-button">
          <!-- icono lupa -->
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path
              d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div
    class="users-container grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 max-w-screen-xl mx-auto px-4"
    id="users-container"></div>
  <div id="modals-container"></div>

  <div class="pagination-container">
    <button id="prev-page" class="pagination-button" disabled>Anterior</button>
    <div class="page-numbers" id="page-numbers"></div>
    <button id="next-page" class="pagination-button">Siguiente</button>
  </div>

  <div class="overlay fixed inset-0 bg-black bg-opacity-50 z-50 hidden transition-opacity duration-1000 ease-in-out opacity-0" id="overlay"></div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("username-search");
    let userCards = [];
    let filteredUsers = [];
    const usersContainer = document.getElementById("users-container");
    const modalsContainer = document.getElementById("modals-container");

    const prevBtn = document.getElementById("prev-page");
    const nextBtn = document.getElementById("next-page");
    const pageNumbers = document.getElementById("page-numbers");
    const dateFilter = document.getElementById("date-filter");

    let currentPage = 1;
    const itemsPerPage = 15;

    const today = new Date().toISOString().split('T')[0];
    if (!dateFilter.value) {
      dateFilter.value = today;
    }

    dateFilter.addEventListener("change", async (e) => {
      const selectedDate = e.target.value;
      if (!selectedDate) return;

      try {
        const response = await fetch("/get-logs-by-date", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ date: selectedDate }),
        });

        if (!response.ok) throw new Error("Error fetching data");

        const usersData = await response.json();
        updateUsersData(usersData);
      } catch (error) {
        console.error("Error:", error);
        alert("Error al cargar los datos");
      }
    });

    function updateUsersData(usersData) {
      console.log(usersData);
      const cardsHTML = usersData.map((user, index) => `
    <div class="user-card  w-full max-w-[320px] mx-auto rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition duration-300 flex flex-col justify-between overflow-hidden" data-username="${user.username.toLowerCase()}">
      <header class="card-header flex flex-col items-center p-4 bg-gradient-to-l from-[#00D2C8] to-[#1A8A9D] text-[#FAEAFF]">
        <div class="avatar bg-[var(--primary-color)] text-white text-[1.9rem] font-bold w-[100px] h-[100px] rounded-full flex items-center justify-center border-[4px] border-white mb-0">${user.username.charAt(0).toUpperCase()}</div>
        <div class="user-info text-center mt-0">
          <h3 class="username font-semibold text-[1.2rem] text-[#FAEAFF] mb-0">${user.username}</h3>
          <span class="ip-address text-[0.9rem] text-[#FAEAFF]">${user.ip}</span>
        </div>
      </header>

      <div class="card-action">
        <button class="activity-button" onclick="event.stopPropagation(); openLogsModal(${index});">
          ACTIVIDAD
        </button>
      </div>

      <footer class="card-footer">
        <div class="footer-item">
          <span class="label">Requests:</span>
          <span class="value">${user.total_requests}</span>
        </div>
        <div class="footer-item">
          <span class="label">Data:</span>
          <span class="value">${formatBytes(user.total_data)}</span>
        </div>
      </footer>
    </div>
  `).join('');

      const modalsHTML = usersData.map((user, index) => {
        // Conteo agrupado por rango de status
        const responseCounts = {
          informational: 0,   // 100–199
          successful: 0,      // 200–299
          redirection: 0,     // 300–399
          clientError: 0,     // 400–499
          serverError: 0,     // 500–599
          unknown: 0          // Otros códigos
        };

        user.logs.forEach(log => {
          const code = log.response;
          if (code >= 100 && code <= 199) responseCounts.informational++;
          else if (code >= 200 && code <= 299) responseCounts.successful++;
          else if (code >= 300 && code <= 399) responseCounts.redirection++;
          else if (code >= 400 && code <= 499) responseCounts.clientError++;
          else if (code >= 500 && code <= 599) responseCounts.serverError++;
          else responseCounts.unknown++;
        });

        // Definimos íconos y colores para cada rango
        const responseGroups = {
          informational: { icon: 'fa-info-circle', color: 'text-blue-500', label: 'Respuestas informativas (100–199)' },
          successful: { icon: 'fa-circle-check', color: 'text-green-500', label: 'Respuestas exitosas (200–299)' },
          redirection: { icon: 'fa-arrow-right', color: 'text-yellow-500', label: 'Mensajes de redirección (300–399)' },
          clientError: { icon: 'fa-circle-xmark', color: 'text-red-500', label: 'Respuestas de error del cliente (400–499)' },
          serverError: { icon: 'fa-triangle-exclamation', color: 'text-orange-400', label: 'Respuestas de error del servidor (500–599)' },
          unknown: { icon: 'fa-question', color: 'text-gray-500', label: 'Otros' }
        };

        const responseSummary = Object.entries(responseCounts).map(([key, count]) => {
          if (count === 0) return ''; // No mostramos rangos sin conteo
          const { icon, color, label } = responseGroups[key];
          return `
      <div class="flex items-center gap-1 text-sm ${color}" title="${label}">
        <i class="fa-solid ${icon}"></i>
        <span>${count}</span>
      </div>`;
        }).join('');

        // Luego devuelves el HTML completo del modal, usando responseSummary
        return `
  <div class="logs-modal hidden fixed inset-0 bg-[var(--modal-bg)] z-[1000] flex justify-center items-center transition-all duration-1000 ease-in-out opacity-0" id="logs-modal-${index}">
    <div class="modal-content bg-white p-8 rounded-2xl w-[90%] max-w-[600px] max-h-[80vh] overflow-y-auto shadow-[0_10px_30px_rgba(0,0,0,0.3)] transition-all duration-1000 ease-in-out relative onmouseleave="closeLogsModal(${index})">
      <div class="flex justify-between items-center mb-2">
        <button onclick="closeLogsModal(${index})" class="absolute top-3 right-4 text-gray-500 hover:text-red-500 text-xl font-bold z-10" title="Cerrar">
          &times;
        </button>
        <h4 class="logs-title text-lg font-semibold">
          Actividad reciente - <span class="username-highlight">${user.username}</span>
        </h4>
        <div class="flex gap-4 items-center">
          ${responseSummary}
        </div>
      </div>

      <div class="logs-list space-y-2 mt-2">
        ${user.logs.length > 0
            ? user.logs.map(log => {
              const truncatedUrl = truncate(log.url, 40);
              const isHttps = /:(443|8443)$/.test(log.url);
              const protocol = isHttps ? 'https://' : 'http://';
              const fullUrl = log.url.startsWith('http') ? log.url : protocol + log.url;

              const responseColors = {
                100: 'bg-blue-400',
                200: 'bg-green-500',
                300: 'bg-yellow-400',
                400: 'bg-red-500',
                500: 'bg-orange-400',
                0: 'bg-gray-400'
              };

              // Para badge, elige color según rango de código
              let badgeClass = 'bg-gray-400';
              if (log.response >= 100 && log.response <= 199) badgeClass = 'bg-blue-400';
              else if (log.response >= 200 && log.response <= 299) badgeClass = 'bg-green-500';
              else if (log.response >= 300 && log.response <= 399) badgeClass = 'bg-yellow-400';
              else if (log.response >= 400 && log.response <= 499) badgeClass = 'bg-red-500';
              else if (log.response >= 500 && log.response <= 599) badgeClass = 'bg-orange-400';

              return `
              <div class="log-entry flex justify-between items-start gap-3 border-b border-gray-200 pb-1">
                <div class="flex-1">
                  <div class="log-url text-sm font-medium text-gray-800">${truncatedUrl}</div>
                  <div class="log-details mt-1 flex flex-wrap gap-3 text-sm text-gray-600">
                    <span class="response-badge ${badgeClass} inline-block px-2 py-[0.15rem] rounded-md text-[0.65rem] font-medium text-white mr-2">${log.response}</span>
                    <span class="log-meta">${log.request_count} reqs</span>
                    <span class="log-meta">${formatBytes(log.data_transmitted)}</span>
                  </div>
                </div>
                <div class="self-start">
                  <i class="fa-solid fa-up-right-from-square text-blue-600 hover:text-blue-800 cursor-pointer text-lg"
                    title="Abrir enlace"
                    onclick="window.open('${fullUrl}', '_blank')"></i>
                </div>
              </div>`;
            }).join('')
            : '<div class="no-logs text-gray-500">No hay actividad registrada</div>'
          }
      </div>
    </div>
  </div>`;
      }).join('');



      usersContainer.innerHTML = cardsHTML;
      modalsContainer.innerHTML = modalsHTML;

      userCards = Array.from(document.querySelectorAll(".user-card"));
      filteredUsers = [...userCards];

      renderPage(1);
      filterUsers();
    }

    function truncate(str, n) {
      return str.length > n ? str.slice(0, n - 1) + "..." : str;
    }

    function formatBytes(bytes) {
      const units = ["B", "KB", "MB", "GB"];
      let value = bytes;
      let unitIndex = 0;
      while (value >= 1024 && unitIndex < units.length - 1) {
        value /= 1024;
        unitIndex++;
      }
      return `${value.toFixed(2)} ${units[unitIndex]}`;
    }

    function renderPage(page = 1) {
      const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
      currentPage = Math.min(Math.max(1, page), totalPages);

      userCards.forEach(card => (card.style.display = "none"));

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = filteredUsers.slice(start, end);

      pageItems.forEach(card => (card.style.display = ""));

      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;

      pageNumbers.innerHTML = `Página ${currentPage} de ${totalPages}`;
    }

    function filterUsers() {
      const searchValue = searchInput.value.toLowerCase();
      filteredUsers = userCards.filter(card => {
        const username = card.getAttribute("data-username");
        return username.includes(searchValue);
      });
      renderPage(1);
    }

    searchInput.addEventListener("input", filterUsers);
    prevBtn.addEventListener("click", () => renderPage(currentPage - 1));
    nextBtn.addEventListener("click", () => renderPage(currentPage + 1));

    renderPage(1);
    dateFilter.dispatchEvent(new Event("change"));
  });

    function openLogsModal(index) {
      const modal = document.getElementById(`logs-modal-${index}`);
      const overlay = document.getElementById('overlay');
      const modalContent = modal.querySelector('.modal-content');

      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        requestAnimationFrame(() => {
          modal.classList.remove('opacity-0');
          modal.classList.add('opacity-100');
        });

        if (overlay) {
          overlay.classList.remove('hidden');
          requestAnimationFrame(() => {
            overlay.classList.add('opacity-100');
            overlay.classList.remove('opacity-0');
          });
        }
      }
    }

  function closeLogsModal(index) {
      const modal = document.getElementById(`logs-modal-${index}`);
      const overlay = document.getElementById('overlay');

      if (modal) {
        modal.classList.remove('opacity-100');
        modal.classList.add('opacity-0');

        // Espera a que termine la animación antes de ocultar
        setTimeout(() => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        }, 1000); // Debe coincidir con la duracion de la clase
      }

      if (overlay) {
        overlay.classList.remove('opacity-100');
        overlay.classList.add('opacity-0');
        setTimeout(() => {
          overlay.classList.add('hidden');
        }, 1000);
      }

    }

  </script>